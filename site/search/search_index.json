{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Cell Segmentation Explorer","text":"<p>Bin2Cell Explorer is a TissUUmaps plugin that brings the interactive features from the original <code>Bin2Cell_demo.ipynb</code> notebook into the viewer. It lets scientists explore Bin2Cell-expanded labels on top of H&amp;E imagery, switch between gene-expression and observation overlays, and export the rendered regions.</p> <p>\ud83c\udf10 Live Documentation | \ud83d\udd2c Interactive Demo</p>"},{"location":"#overview","title":"Overview","text":"<p>The plugin interface with dataset loading controls.</p> <p></p> <p>Exploring cell segmentation overlays on H&amp;E tissue imagery.</p>"},{"location":"#core-features","title":"Core Features","text":"<ul> <li>Dataset loader for H&amp;E TIFF, Bin2Cell label NPZ, and annotated AnnData (<code>.h5ad</code>).</li> <li>Gene overlays: color expanded-cell regions by expression (gradient or binary).</li> <li>Observation overlays: majority-vote categorical labels per expanded cell.</li> <li>Tile navigation: dropdown, a tile overview minimap, optional on-slide grid.</li> <li>Per-tile rendering: users choose any tile and re-render quickly.</li> <li>Caching and persistence: dataset only loads once; configuration is stored for re-hydration across sessions.</li> <li>Export tools: write the current overlay to GeoJSON; save presets for frequently used parameter sets.</li> </ul> <p>This documentation explains how the plugin is structured, the environment it expects, and the engineering decisions behind each part so future developers can maintain and extend it confidently.</p>"},{"location":"architecture/","title":"Architecture","text":"<p>Bin2Cell Explorer combines a Python backend (Flask plugin) and a JavaScript frontend layered onto TissUUmaps\u2019 OpenSeadragon viewer. This section documents the main components and the engineering decisions that shaped them.</p>"},{"location":"architecture/#high-level-diagram","title":"High-level Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Bin2CellExplorer.js \u2502  UI controls, overlays, minimap, AJAX calls\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502  /plugins/Bin2CellExplorer/{endpoint}\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Bin2CellExplorer.py \u2502  Dataset loaders, cache, overlay builder, presets, exports\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502  Local FS + in-memory cache\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Data assets         \u2502  he.tiff, he.npz, P2_CRC_annotated.h5ad\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#backend-bin2cellexplorerpy","title":"Backend (<code>Bin2CellExplorer.py</code>)","text":""},{"location":"architecture/#dataset-loading-path","title":"Dataset Loading Path","text":"<ol> <li>Normalize paths and expand <code>~</code>.</li> <li>Load H&amp;E TIFF via <code>skimage.io.imread</code> (uses <code>imagecodecs</code> for LZW).</li> <li>Load sparse labels (<code>scipy.sparse.load_npz</code>).</li> <li>Load AnnData with <code>anndata.read_h5ad</code>.</li> <li>Cache the context (H&amp;E, sparse labels, centroid coordinates, AnnData) and tile definitions in a module-level state.</li> <li>Persist dataset metadata to <code>dataset_state.json</code> for rehydration across sessions.</li> </ol> <p>Key choices</p> <ul> <li>Caching: heavy assets only load once. Subsequent overlay calls reuse cached data, preventing repeated 4\u202fGB loads.</li> <li>Lazy rehydration: <code>_ensure_context()</code> can rebuild <code>B2CContext</code> if the module is reloaded or the Flask plugin is re-instantiated.</li> <li>Error handling: <code>try/except</code> around every endpoint with <code>_error_response</code> ensures the UI receives structured JSON (never raw HTML error pages).</li> <li>TileCache: per-tile overlay data (expanded labels, polygons) is cached with an LRU eviction to avoid recomputing for repeated requests.</li> </ul>"},{"location":"architecture/#overlay-generation","title":"Overlay Generation","text":"<p><code>get_overlay</code> accepts a tile ID plus gene/observation parameters and returns:</p> <ul> <li>Expanded and raw label polygons (per cell) plus outlines.</li> <li>Centroid bookkeeping (used server-side to aggregate expression and majority votes).</li> <li>Legend metadata (continuous gradient or categorical swatches).</li> </ul> <p>Steps:</p> <ol> <li>Retrieve tile info (<code>_tile_entry</code>) \u2014 computes or fetches cached expanded labels, polygons, outlines.</li> <li>Branch on overlay type:</li> <li>Gene: compute maximum expression per expanded cell, map to colors, optionally limit top N or quantile.</li> <li>Observation: majority vote over expanded cell, map categories, filter if requested.</li> <li>Return structured JSON for the frontend to draw.</li> </ol>"},{"location":"architecture/#exporting-presets","title":"Exporting &amp; Presets","text":"<ul> <li><code>export_overlay</code>: reuses <code>get_overlay</code>, converts polygons to GeoJSON.</li> <li><code>save_preset/list_presets/delete_preset</code>: CRUD operations on a JSON file stored under <code>~/.tissuumaps/plugins/Bin2CellExplorer/presets.json</code>.</li> </ul>"},{"location":"architecture/#frontend-bin2cellexplorerjs","title":"Frontend (<code>Bin2CellExplorer.js</code>)","text":""},{"location":"architecture/#ui-construction","title":"UI Construction","text":"<p>Declared parameters drive the autogenerated form (via TissUUmaps plugin system). Key custom elements:</p> <ul> <li>Tile overview canvas (minimap) with click-to-jump behavior.</li> <li>Outline toggles (expanded vs. nuclei) that switch both fills and helper outlines.</li> <li>Overlay legend with checkboxes to toggle categories or genes without rerendering.</li> </ul>"},{"location":"architecture/#data-flow","title":"Data Flow","text":"<ol> <li>User actions trigger <code>inputTrigger</code>.</li> <li>Load dataset \u2192 <code>load_dataset</code> endpoint \u2192 update internal state and the tile overview.</li> <li>Update overlay \u2192 <code>get_overlay</code> endpoint \u2192 render overlay and legend.</li> <li>Export/preset actions follow similar request/response loops.</li> </ol>"},{"location":"architecture/#rendering","title":"Rendering","text":"<ul> <li>SVG overlay: uses OpenSeadragon\u2019s SVG overlay (<code>overlayUtils._d3nodes</code>) to draw polygons and helper outlines.</li> <li>Tile overview: HTML canvas minimap (~320\u202fpx square) with gradient styling; clicking selects and centers tiles, so an extra on-slide grid is unnecessary.</li> <li>Viewport utilities: helper functions convert pixel coordinates to viewport space (accounting for image flip).</li> </ul>"},{"location":"architecture/#interaction-helpers","title":"Interaction Helpers","text":"<ul> <li><code>panToTile(tileId, animate)</code> \u2192 centers the viewer on a tile by converting pixel coordinates to OpenSeadragon <code>Rect</code>.</li> <li><code>renderTileOverview()</code> \u2192 redraws minimap whenever tiles load or selection changes.</li> <li><code>attachTileSelectListener()</code> \u2192 keeps dropdown, minimap, and viewer selection in sync.</li> </ul>"},{"location":"architecture/#data-files","title":"Data Files","text":"File Role Notes <code>he.tiff</code> Full-resolution H&amp;E image ~830\u202fMB LZW-compressed; decompression handled via <code>imagecodecs</code>. <code>he.npz</code> Sparse label matrix <code>scipy.sparse.csr_matrix</code>; used to drive Bin2Cell expansion. <code>P2_CRC_annotated.h5ad</code> AnnData with expression + observations ~4\u202fGB; must fit in RAM. Optional optimizations include using Zarr or downsampling."},{"location":"architecture/#performance-considerations","title":"Performance Considerations","text":"<ul> <li>Initial load: dominated by reading TIFF + <code>.h5ad</code>; expect ~20\u201330\u202fseconds on SSD. Loading is single-threaded (library limitation).</li> <li>Overlay computation: per tile, typically &lt; 1\u202fs thanks to caching of expanded labels.</li> <li>Memory footprint: entire H&amp;E (\u22481.2\u202fGB in RAM), sparse labels, AnnData (4\u202fGB), plus caches. Ensure \u22658\u202fGB free RAM during development.</li> <li>Tile overview: drawn in canvas to avoid heavy DOM operations; scaled rendering keeps hover/selection lightweight even for thousands of tiles.</li> </ul>"},{"location":"architecture/#extensibility-hooks","title":"Extensibility Hooks","text":"<ul> <li>New overlay types: add a branch in <code>_prepare_gene_overlay</code> / <code>_prepare_obs_overlay</code> or create a new handler. Extend the JS rendering branch to draw the new type.</li> <li>Batch export: reuse <code>_tile_entry</code> to iterate all tiles and write overlay mosaics.</li> <li>Viewport-triggered overlays: monitor OpenSeadragon <code>animation-finish</code> events to lazy-request overlays as the user pans.</li> </ul>"},{"location":"guide/","title":"Usage &amp; Developer Guide","text":"<p>This guide covers both end-user workflows and developer setup for the Bin2Cell Explorer plugin.</p>"},{"location":"guide/#usage","title":"Usage","text":""},{"location":"guide/#1-launch-tissuumaps-with-uv","title":"1. Launch TissUUmaps with uv","text":"<pre><code>cd ~/.tissuumaps\nuv sync                              # only after dependency changes\nQTWEBENGINE_CHROMIUM_FLAGS=\"--disable-features=SkiaGraphite\" uv run tissuumaps\n</code></pre> <p>The optional <code>QTWEBENGINE_CHROMIUM_FLAGS</code> silences the Skia Graphite \u2192 Ganesh fallback log. Omit it if you want the default logging.</p>"},{"location":"guide/#2-load-the-dataset-once","title":"2. Load the dataset once","text":"<p>Open Plugins \u2192 Bin2Cell Explorer and either paste the absolute paths into the three text fields or click the matching Browse\u2026 buttons to select each file with the system dialog (filters default to <code>.tif/.tiff</code>, <code>.npz</code>, and <code>.h5ad</code>).</p> <p>Click Load dataset. The status line and log show <code>Dataset loaded successfully: \u2026 tiles</code>. The plugin caches the dataset so later overlay updates are instant and the selected paths persist between sessions.</p> <p>Tip: The initial load reads an 830 MB TIFF and a 4 GB <code>.h5ad</code>, so it can take ~20\u201330 seconds. Avoid clicking \"Load dataset\" repeatedly; the plugin will reuse the cached dataset automatically.</p>"},{"location":"guide/#3-orient-yourself-with-the-tile-overview","title":"3. Orient yourself with the tile overview","text":"<p>Scroll a little in the plugin panel to the Tile overview minimap:</p> <ul> <li>Each tile is a rectangle labelled with its numeric ID.</li> <li>Clicking a rectangle selects that tile, updates the dropdown, highlights it in amber, and pans/zooms the main viewer directly to that region.</li> </ul> <p>The minimap is larger now, so you can comfortably click tiles even on dense slides without needing an on-slide grid.</p>"},{"location":"guide/#4-choose-your-overlay","title":"4. Choose your overlay","text":"<p>Select a tile via the minimap or dropdown, then set overlay parameters:</p> <ul> <li>Gene overlay: choose <code>Overlay type = gene</code>, enter a gene (e.g., <code>COL1A1</code>), pick color mode (<code>gradient</code>, <code>binary</code>, or <code>solid</code>), and click Update overlay. Use the colour picker below the dropdown: it adjusts the gradient ramp when <code>gradient</code> is selected, or sets the fill/stroke colour in <code>solid</code> mode.</li> <li>Observation overlay: choose <code>Overlay type = observation</code>, pick an observation column (e.g., <code>predicted_ClusterFull</code>, <code>predicted_ClusterMidway</code>, or <code>predicted_ClusterTop</code>), then use the now-populated Category filter dropdown if you want to isolate a single lineage. Leaving it on \"All categories\" renders every class with the <code>AnnData.uns['&lt;column&gt;_colors']</code> palette.</li> </ul>"},{"location":"guide/#bin2cell-parameters-what-the-four-numbers-mean","title":"Bin2Cell parameters (what the four numbers mean)","text":"<ul> <li>Max bin distance (\u00b5m): caps how far each nucleus can inflate. The plugin converts it to pixels via <code>distance_px = ceil(max_bin_distance * (bin_um / mpp))</code>, so doubling the distance or bin size doubles the apparent halo.</li> <li>Microns per pixel (mpp): physical resolution of the slide. Lower values mean each pixel maps to fewer microns, so the same bin distance spans more pixels.</li> <li>Bin size (\u00b5m): physical size of the Bin2Cell bin; paired with <code>mpp</code> to keep distance scaling consistent when you swap datasets.</li> <li>Volume ratio: only used when <code>Expand mode = volume_ratio</code>. Instead of using the fixed cap, it inflates each nucleus so the expanded area approximates <code>volume_ratio \u00d7 (original area)</code>; the plugin converts that area delta to an average radial offset.</li> </ul> <p>Tuning any of the first three numbers affects the others because the distance is ultimately applied in pixels. A typical workflow is to keep <code>mpp</code> from the slide metadata, set <code>bin_um</code> to the Bin2Cell bin size used upstream, and then tweak <code>max_bin_distance</code> (or <code>volume_ratio</code>) to control how much the halos bleed into neighbours.</p> <p>Legend checkboxes let you toggle categories or gene overlays without re-rendering.</p>"},{"location":"guide/#5-optional-layers-and-exports","title":"5. Optional layers and exports","text":"<ul> <li>Toggle Show expanded outlines to visualize the Bin2Cell expansion (fills + outlines) or Show nuclei outlines to overlay the original segmentation contours. Turn both on if you want to compare halo vs. nucleus footprints simultaneously.</li> <li>When Show expanded outlines is unchecked the filled shapes follow the original nuclei contours; enable it if you want to visualize the Bin2Cell-expanded radius alongside (and as the basis for) the overlay.</li> <li>Click Export overlay to GeoJSON to capture the current overlay for downstream analysis.</li> <li>Save reusable settings via the Presets section.</li> </ul>"},{"location":"guide/#6-resetting-or-switching-datasets","title":"6. Resetting or switching datasets","text":"<p>If you need to work with a different slide:</p> <ol> <li>Update the file paths.</li> <li>Click Load dataset once.</li> <li>The plugin updates the cache (<code>dataset_state.json</code>) and refreshes the tile overview automatically.</li> </ol> <p>That's it\u2014once the dataset is loaded you can hop between tiles, switch genes or observation columns, and export overlays without repeating the heavy load step.</p>"},{"location":"guide/#developer-setup","title":"Developer Setup","text":""},{"location":"guide/#environment-setup","title":"Environment Setup","text":""},{"location":"guide/#1-install-uv-one-time","title":"1. Install uv (one time)","text":"<pre><code>curl -LsSf https://astral.sh/uv/install.sh | sh\nexport PATH=\"$HOME/.local/bin:$PATH\"   # add to ~/.zshrc for convenience\n</code></pre>"},{"location":"guide/#2-sync-the-managed-environment","title":"2. Sync the managed environment","text":"<p>From the project root (<code>~/.tissuumaps</code>):</p> <pre><code>uv sync\n</code></pre> <p>This creates/updates <code>.venv</code> with the locked runtime stack (anndata, numpy, scikit-image, matplotlib, tissuumaps, PySide6 6.7 LTS, etc.) plus dev tools (<code>pytest</code>, <code>mkdocs</code>, \u2026).</p> <p>To work in an activated shell:</p> <pre><code>source .venv/bin/activate\n# ...run commands...\ndeactivate\n</code></pre>"},{"location":"guide/#3-launch-tissuumaps-through-uv","title":"3. Launch TissUUmaps through uv","text":"<pre><code>uv run tissuumaps\n</code></pre> <p>Add <code>QTWEBENGINE_CHROMIUM_FLAGS=\"--disable-features=SkiaGraphite\"</code> if you want to suppress the Skia fallback message. The desktop app inherits the <code>.venv</code> environment without requiring conda.</p>"},{"location":"guide/#4-place-the-plugin-files","title":"4. Place the plugin files","text":"<p>Keep the plugin code inside the TissUUmaps configuration directory:</p> <pre><code>~/.tissuumaps/\n\u2514\u2500\u2500 plugins/\n    \u251c\u2500\u2500 Bin2CellExplorer.py\n    \u251c\u2500\u2500 Bin2CellExplorer.js\n    \u251c\u2500\u2500 Bin2CellExplorer.yml\n    \u2514\u2500\u2500 Bin2CellExplorer/\n        \u2514\u2500\u2500 Bin2CellExplorer.log   # auto-generated\n</code></pre> <p>Dataset assets (<code>.tif/.tiff</code>, <code>.npz</code>, <code>.h5ad</code>) can live anywhere on disk. In the UI you can paste absolute paths or click the matching Browse\u2026 buttons to open a filtered file dialog for each requirement.</p>"},{"location":"guide/#project-layout","title":"Project Layout","text":"File Purpose <code>Bin2CellExplorer.py</code> Flask plugin backend. Handles dataset loading, caching, overlay generation, exporting, and preset persistence. <code>Bin2CellExplorer.js</code> Front-end logic. Builds the UI, calls backend endpoints, renders overlays, and drives the minimap. <code>Bin2CellExplorer.yml</code> Plugin metadata for TissUUmaps. <code>he.tiff</code> / <code>he.npz</code> / <code>P2_CRC_annotated.h5ad</code> Sample data used during development and demos. Replace with user data as needed. <code>Bin2CellExplorer.log</code> Rolling log (one per plugin) capturing load/overlay operations."},{"location":"guide/#running-mkdocs-locally","title":"Running MkDocs locally","text":"<pre><code>uv run --group dev mkdocs serve\n</code></pre> <p>The docs are served at <code>http://127.0.0.1:8000</code>. Hit <code>Ctrl+C</code> to stop. For a static build use <code>uv run --group dev mkdocs build</code>.</p>"},{"location":"guide/#debugging-tips","title":"Debugging Tips","text":"<ul> <li>Tail the log while testing: <code>tail -f ~/.tissuumaps/plugins/Bin2CellExplorer/Bin2CellExplorer.log</code>.</li> <li>If you change data paths, delete <code>~/.tissuumaps/plugins/Bin2CellExplorer/dataset_state.json</code> to force a full reload.</li> <li>When overlays are missing, confirm the tile ID exists and that the AnnData column/gene is valid (per the notebook).</li> <li><code>scanpy.read_h5ad(\"P2_CRC_annotated.h5ad\")</code> is a quick sanity check that the <code>.h5ad</code> can be loaded.</li> </ul>"},{"location":"guide/#common-tasks","title":"Common Tasks","text":""},{"location":"guide/#updating-dependencies","title":"Updating Dependencies","text":"<ol> <li>Add or bump dependencies in <code>pyproject.toml</code> (use <code>uv add &lt;package&gt;</code> for runtime, <code>uv add --group dev &lt;package&gt;</code> for tooling).</li> <li>Run <code>uv lock</code> (if required) and <code>uv sync</code> to refresh <code>.venv</code>.</li> <li>Document noteworthy changes here and in <code>docs/architecture.md</code>.</li> </ol>"},{"location":"guide/#adding-new-ui-controls","title":"Adding New UI Controls","text":"<ul> <li>Define the control in <code>Bin2CellExplorer.parameters</code>.</li> <li>Handle it in <code>inputTrigger</code>.</li> <li>Add the required state fields or backend parameters.</li> <li>Update documentation (<code>guide.md</code> or <code>architecture.md</code>) to keep feature parity.</li> </ul>"},{"location":"guide/#extending-backend-endpoints","title":"Extending Backend Endpoints","text":"<ul> <li>Follow the existing pattern: sanitize inputs, wrap logic in <code>try/except</code>, return JSON responses via <code>_json_response</code>.</li> <li>Prefer raising Python exceptions (the <code>Plugin</code> wrapper converts them into structured error payloads).</li> <li>For heavy operations, cache results via <code>TileCache</code>.</li> </ul>"},{"location":"guide/#release-checklist","title":"Release Checklist","text":"<ol> <li>Verify <code>Bin2CellExplorer.yml</code> version.</li> <li>Run through the usage steps end-to-end with sample data.</li> <li>Ensure <code>Bin2CellExplorer.log</code> is free of unexpected errors.</li> <li>Regenerate documentation if anything changed (<code>mkdocs build</code>).</li> <li>Package plugin files with any sample data provided to users.</li> </ol> <p>With these steps a new developer can reproduce the environment, understand the code layout, and extend the plugin safely.</p>"}]}